<!DOCTYPE html>
<html lang="en">
    <head>
        <title>扫雷</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <style>
            /* Css Style */
            body {
                text-align: center;
                margin: 0;
                padding: 0;
            }

            .minesweeper td {
                width: 70px;
                height: 70px;
                text-align: center;
                background-color: rgb(189, 189, 189);
                font-family: monospace;
                box-shadow: 2px 2px 0 0 rgb(156, 156, 156),3px 3px 0 0 rgb(123,123,123),-3px -3px 0 0 rgb(254, 254, 254),-2px -2px 0 0 rgb(222,222,222);
                font-weight: bold;
                background-size: 60px 60px;
                background-position: center;
                background-repeat: no-repeat;
                margin: 0 auto;
                border: 1px solid;
                font-size: 50px;
            }

            .minesweeper {
                margin: 0 auto;
                padding: 10px;
                font-size: xx-small;
                border-collapse: collapse;
            }
            
            #gameHead {
                margin: 0 auto;
                text-align: center;
                width: 100%;
                font-family: monospace;
            }

            #gameHead td {
                background-color: transparent;
                border: none;
                box-shadow: none;
                font-size: 23px;
            }

            @media only screen and (max-width: 700px) {
                #gameHead td {
                    font-size: medium;
                }

                .minesweeper td {
                    width: 35px;
                    height: 35px;
                    font-size: 25px;
                    background-size: 30px 30px;
                    background-repeat: no-repeat;
                    background-position: center;
                    font-weight: bold;
                }
            }
        </style>
    </head>
    <body>
        <audio id="lose_audio">
            <source src="bomb_explosion.mp3" type="audio/mpeg">
        </audio>
        <audio id="click_audio">
            <source src="Minesweeper_Click.mp3" type="audio/mpeg">
        </audio>
        <br>
        <table id="gameHead">
            <tr>
                <td>
                    <div id="remaining_flag_number" style="text-align: left;"></div>
                </td>
                <td>
                    <div id="bigtitle" style="font-weight: bold;">Minesweeper</div>
                </td>
                <td>
                    <div class="flag_mode_div" style="text-align: right;">
                        <span id="total_used_time" style="text-align: right;">0</span>
                        <input type="checkbox" value="flag_mode" name="flag_mode" onchange="flag_mode_function()" id="flag_mode">
                        <label for="flag_mode" id="flag_mode_label"> Flag Mode</label>
                    </div>
                </td>
            </tr>
        </table>
        <br>
        <div>
            <table class="minesweeper" id="minesweeper_table"></table>
        </div>
        <script>
            // Variables
            var landmine_coor = [];
            var click_row_number = 0;
            var click_column_number = 0;
            var minesweeper_table = document.getElementById("minesweeper_table");
            var changed_value;
            var left_flag = 8;
            var total_time = 0;
            var win_percentage = 1;
            var tr_cell;
            var enable_flag_mode_or_not = false;
            var first_click = true;
            var map = [
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0]
            ];
            var expanded = [
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0]
            ];
            var flag_map = [
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0]
            ];
            var map_size = 9;
            var landmine_count = 8;
            var mouseDownTime = 0;
            var timeOutId = null;
            var isFlagged = false;
            var tr_cells;
            var td_cells;

            for (let r = 0;r<map_size;r++) {
                const createTr = document.createElement("tr");
                createTr.id = r;
                minesweeper_table.appendChild(createTr);
                for (let c = 0;c<map_size;c++) {
                    const createTd = document.createElement("td");
                    document.getElementById(r).appendChild(createTd);
                };
            };



            td_cells = document.querySelectorAll("td");
            tr_cells = document.querySelectorAll("tr");

            // use EventListener instead of "onclick"
            td_cells.forEach(detect_td_onclick => {
                detect_td_onclick.addEventListener("click",function(event){
                    click_column(this);
                });
            });

            tr_cells.forEach(detect_tr_onclick => {
                if (detect_tr_onclick.parentNode.parentNode.id != "gameHead") {
                    detect_tr_onclick.addEventListener("click",function(event){
                        click_row(this);
                    });
                };
            });

            td_cells.forEach(hold_right_click => {
                hold_right_click.addEventListener("mousedown",function(event) {
                    mouseDownTime = Date.now();

                    timeOutId = setTimeout(function() {
                        const currentTime = Date.now();
                        if (currentTime - mouseDownTime >= 1000 && !isFlagged) {
                            right_click(hold_right_click);
                            isFlagged = true;
                        };
                    },1000);
                });

                hold_right_click.addEventListener("mouseup",function(event) {
                    clearTimeout(timeOutId);
                });
            });

            function flag_mode_function() {
                enable_flag_mode_or_not = document.getElementById("flag_mode").checked;
            };

            document.getElementById("remaining_flag_number").innerHTML = left_flag + " more flags"
            const record_time = setInterval(update_time,1000);
            function update_time() {
                total_time += 1;
                document.getElementById("total_used_time").innerHTML = total_time;
            };

            function init(click_row_number,click_column_number) {
                for (let i=0;i<landmine_count;i++) {
                    // Get the landmine coords
                    let random_row = Math.floor(Math.random() * landmine_count); // Random row
                    let random_column = Math.floor(Math.random() * landmine_count); // Random col
                    random_row = random_row.toString();
                    random_column = random_column.toString();
                    let added_value = random_row + random_column;
                    // Prevent same number from appearing
                    if (landmine_coor.includes(added_value) || added_value == (click_row_number.toString() + click_column_number.toString())) {
                        i -= 1;
                        continue;
                    } else {
                        landmine_coor.push(added_value);
                        map[random_row][random_column] = 9;
                    }; 
                }; 
                
                for (let r = 0;r < map_size;r++) {
                    for (let c = 0;c < map_size;c++) {
                        var landmine_beside = 0;
                        if (map[r][c] != 9) {
                            if (r-1 >= 0 && c-1 >= 0 ) {
                                if (map[r-1][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r-1 >= 0) {
                                if (map[r-1][c] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r-1 >= 0 && c+1 <= map_size-1 ) {
                                if (map[r-1][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (c-1 >= 0 ) {
                                if (map[r][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (c+1 <= map_size-1 ) {
                                if (map[r][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1 && c-1 >= 0 ) {
                                if (map[r+1][c-1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1) {
                                if (map[r+1][c] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            if (r+1 <= map_size-1 && c+1 <= map_size-1) {
                                if (map[r+1][c+1] == 9 ) {
                                    landmine_beside += 1
                                };
                            }
                            map[r][c] = landmine_beside;
                        }
                    }
                }
            }

            function click_row(row) {
                // Get the row number
                if (!enable_flag_mode_or_not) {
                    click_row_number = row.rowIndex;
                    if (first_click) {
                        init(click_row_number,click_column_number);
                    }; 
                    check_landmine(click_row_number,click_column_number);
                    if (map[click_row_number][click_column_number] == 0 && !enable_flag_mode_or_not) {
                        expand_cell(click_row_number,click_column_number);
                    };
                    first_click = false;
                };
            };

            function click_column(cell) {
                // Get the cell number
                if (enable_flag_mode_or_not) {
                    right_click(cell);
                } else {
                    click_column_number = cell.cellIndex;
                };
            };

            function expand_cell(row,col) {
                expanded[row][col] = 1;
                if (!landmine_coor.includes(row.toString() + col.toString()) && check_if_there_are_landmine_beside(row,col)) {
                    if (row-1 >= 0 && col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col -1).toString())) {
                            check_landmine(row-1,col-1);
                            if (map[row-1][col-1] == 0 && expanded[row-1][col-1] == 0) {
                                expand_cell(row-1,col-1);
                            };
                        }
                    } 
                    if (row-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col).toString())) {
                            check_landmine(row-1,col);
                            if (map[row-1][col] == 0 && expanded[row-1][col] == 0) {
                                expand_cell(row-1,col);
                            };
                        } 
                    } 
                    if (row-1 >= 0 && col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row-1)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row-1,col+1);
                            if (map[row-1][col+1] == 0 && expanded[row-1][col+1] == 0) {
                                expand_cell(row-1,col+1);
                            };
                        } 
                    }
                    if (col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row)).toString() + parseInt(col - 1).toString())) {
                            check_landmine(row,col-1);
                            if (map[row][col-1] == 0 && expanded[row][col-1] == 0) {
                                expand_cell(row,col-1);
                            };
                        }
                    } 
                    if (col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row,col+1);
                            if (map[row][col+1] == 0 && expanded[row][col+1] == 0) {
                               expand_cell(row,col+1);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1 && col-1 >= 0) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col - 1).toString())) {
                            check_landmine(row+1,col-1);
                            if (map[row+1][col-1] == 0 && expanded[row+1][col-1] == 0) {
                                expand_cell(row+1,col-1);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col).toString())) {
                            check_landmine(row+1,col);
                            if (map[row+1][col] == 0 && expanded[row+1][col] == 0) {
                                expand_cell(row+1,col);
                            };
                        } 
                    }
                    if (row+1 <= map_size-1 && col+1 <= map_size-1) {
                        if (!landmine_coor.includes((parseInt(row+1)).toString() + parseInt(col + 1).toString())) {
                            check_landmine(row+1,col+1);
                            if (map[row+1][col+1] == 0 && expanded[row+1][col+1] == 0) {
                                expand_cell(row+1,col+1);
                            };
                        } 
                    };
                } 
            }

            function check_if_there_are_landmine_beside(row,col) {
                if (landmine_coor.includes(row.toString() + col.toString()) == false) {
                    if (landmine_coor.includes((parseInt(row) - 1).toString() + parseInt(col -1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) - 1).toString() + parseInt(col).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col - 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col + 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row) + 1).toString() + parseInt(col).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row)).toString() + parseInt(col - 1).toString())) {
                        return false;
                    } else if (landmine_coor.includes((parseInt(row)).toString() + parseInt(col + 1).toString())) {
                        return false;
                    } else {
                        return true;
                    };
                } else {
                    return false;
                };
            };

            function check_landmine(click_row_number,click_column_number) {
                var landmine_number = 0;
                changed_value = minesweeper_table.rows[click_row_number].cells[click_column_number];
                if (minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundImage.includes("Minesweeper_Flag_Icon.png")) {
                    if (!isFlagged) {
                        left_flag += 1;
                        document.getElementById("remaining_flag_number").innerHTML = left_flag + " more flags";
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "rgb(189,189,189)";
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundImage = "none";
                        flag_map[click_row_number][click_column_number] = 0;
                    } else {
                        isFlagged = false;
                    };
                } else if (landmine_coor.includes(click_row_number.toString() + "" + click_column_number.toString()) && !minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundImage.includes("Minesweeper_Flag_Icon.png")) {
                    // If the player click on the landmine...
                    changed_value.style.backgroundImage = "url('Minesweeper_Icon_Bomb.png')";
                    changed_value.style.backgroundColor = "red";
                    for (let i = 0;i < landmine_coor.length;i++) {
                        var show_all_landmine = landmine_coor[i].split("");
                        minesweeper_table.rows[show_all_landmine[0]].cells[show_all_landmine[1]].style.backgroundImage = "url('Minesweeper_Icon_Bomb.png')";
                    };
                    document.getElementById("lose_audio").play();
                    clearInterval(record_time);
                    console.log("You Lose");
                    return;
                } else {
                    document.getElementById("click_audio").play();
                    if (map[click_row_number][click_column_number] != 0) {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].innerHTML = map[click_row_number][click_column_number];
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "white";
                    } else {
                        minesweeper_table.rows[click_row_number].cells[click_column_number].style.backgroundColor = "white";
                    }
                };

                    // Change the color of the number depend on the value
                var number_on_the_cell = minesweeper_table.rows[click_row_number].cells[click_column_number].innerHTML;
                if (number_on_the_cell == 1) {
                    minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "blue";
                } else if (number_on_the_cell == 2) {
                    minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "green";
                } else if (number_on_the_cell == 3) {
                    minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "red";
                } else if (number_on_the_cell == 4) {
                    minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "purple";
                } else if (number_on_the_cell >= 5) {
                    minesweeper_table.rows[click_row_number].cells[click_column_number].style.color = "black";
                };
            };



            function right_click(cell) {
                var right_click_row = cell.parentNode.rowIndex;
                if (left_flag > 0 && !first_click && minesweeper_table.rows[right_click_row].cells[cell.cellIndex].innerHTML == "" && flag_map[right_click_row][cell.cellIndex] != 1 && expanded[right_click_row][cell.cellIndex] != 1) {
                    left_flag -= 1;
                    cell.style.backgroundImage = "url('Minesweeper_Flag_Icon.png')"; 
                    document.getElementById("remaining_flag_number").innerHTML = left_flag + " more flags";
                    flag_map[right_click_row][cell.cellIndex] = 1;
                    var won = true;
                    for (let r = 0; r < map_size; r++) {
                        for (let c = 0; c < map_size; c++) {
                            if (map[r][c] == 9 && flag_map[r][c] !== 1) {
                                won = false;
                                break;
                            }
                        }
                        if (!won) {
                            break;
                        }
                    }
    
                    if (won) {
                        win = true; 
                        const winMessage = setTimeout(alert("You Won!"),500);
                        clearInterval(record_time);
                    }
                } else if (left_flag < 0) {
                    console.log("No More Flag!");
                    return;
                };
            };

            td_cells.forEach(cell => {
                cell.addEventListener("contextmenu", function(event) {
                    event.preventDefault();
                    right_click(cell);
                });
            });
        </script>
    </body>
</html>
